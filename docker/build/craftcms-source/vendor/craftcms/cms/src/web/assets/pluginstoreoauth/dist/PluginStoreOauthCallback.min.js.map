{"version":3,"sources":["pluginstoreoauth/src/PluginStoreOauthCallback.js"],"names":["$","Craft","PluginStoreOauthCallback","Garnish","Base","extend","$graphic","$status","errorDetails","data","settings","init","setSettings","this","error","postActionRequest","setTimeout","errorMsg","message","location","html","window","redirectUrl","response","hash","substr","fragments","fragmentString","updateStatus","textStatus","jqXHR","showError","addClass","getCpUrl","showFatalError","msg","t","escapeHtml","statusText","responseText","$buttonContainer","encodeURIComponent","statusHtml","appendTo","$cancelBtn","class","href","text","$retryBtn","getActionUrl","jQuery"],"mappings":"CAAA,SAACA,GACGC,MAAMC,yBAA2BC,QAAQC,KAAKC,OAAO,CACjDC,SADiD,KAEjDC,QAFiD,KAGjDC,aAHiD,KAI7CC,KAJ6C,KAKjDC,SALiD,KAQ7CC,KAAKC,SAAYF,GAOT,GALHJ,KAAAA,YAAaI,GAAlBG,KAAKP,SAAWN,EAAE,YAGba,KAAKH,QAASI,EAAAA,WAENC,KAAAA,SAAAA,MAIJR,CAELS,IAAWC,EAAMJ,KAAAH,SAAAQ,QAAAL,KAAAH,SAAAQ,QAAAL,KAAAH,SAAAI,MACPD,KAACM,QAAWC,KAAKV,GAE9BM,WAAA,KAxB4CK,OAAAF,SAAAN,KAAAH,SAAAY,aA2BjDP,UAbQC,WAAA,KAGGH,KAAAE,qBACCE,MAcJF,kBAAkB,WACd,IAAIQ,EAAgBF,OAAAF,SAAAK,KAAAC,OAAA,GAChBC,EAAeH,EAAAA,oBAAfI,GAEA1B,MAAK2B,kBAAa,0BAAuBF,EAAgB,CAAzDH,EAAAM,EAAAC,KACA,WAAKxB,EAJLiB,EAAST,MAOED,KAAMkB,UAAAR,EAAAT,QAEFK,KAAAA,aAAgBT,MAASY,MAAAA,EAAAA,MAAhC,cAAA,QACGT,KAAAP,SAAA0B,SAAA,WAHXhB,WAAA,UAOH,IAAAH,KAAAH,SAAAY,YACED,OAAAF,SAAAN,KAAAH,SAAAY,YAEND,OAAAF,SAAAlB,MAAAgC,SAAA,iBAlDwC,MAwD/BpB,KACVqB,eAAgBJ,MAzDyBI,eAAA,SAAAJ,GAiFjDC,KAAWzB,SAAS6B,SAAK,SAChB7B,IAAAA,EACAsB,MAAa3B,MAAAmC,EAAQD,MAAM,+BAA3BP,4DAIkB3B,MAAAmC,EAAA,MAAA,WAAA,aAAAnC,MAAAoC,WAAAP,EAAAQ,YAJlBV,+BAIkB3B,MAAAmC,EAAA,MAAA,aAAA,aAAAnC,MAAAoC,WAAAP,EAAAS,cAJlBX,iFAQOY,mBAJZ,wBAMS,SAAIC,mBACT,0GAEMX,EAAAQ,WAFN,iBAGQE,EAJZD,cA7FR,KADJtC,MAAAmC,EAAA,MAAA,iBAyEgB,OAEJvB,KAAKe,aAAac,IAGtBd,aAAc,SAASR,GACnBP,KAAKN,QAAQa,KAAKA,IAGtBW,UAAW,SAASI,GAChBtB,KAAKP,SAAS0B,SAAS,SACvBnB,KAAKe,aAAa,MAAQO,EAAM,QAEhC,IAAIK,EAAmBxC,EAAE,gCAAgC2C,SAAS9B,KAAKN,SAEvEqC,WAAa5C,EAAE,OAAQ,CACnB6C,MAAS,UACTC,KAAQ7C,MAAMgC,SAAS,gBACvBc,KAAM,WACPJ,SAASH,GAEZQ,UAAYhD,EAAE,OAAQ,CAClB6C,MAAS,UACTC,KAAQ7C,MAAMgD,aAAa,wBAC3BF,KAAM,cACPJ,SAASH,MAlGxB,CAqGGU","file":"PluginStoreOauthCallback.min.js","sourcesContent":["(function($) {\n    Craft.PluginStoreOauthCallback = Garnish.Base.extend({\n        $graphic: null,\n        $status: null,\n        errorDetails: null,\n        data: null,\n        settings: null,\n\n        init: function(settings) {\n            this.setSettings(settings);\n\n            this.$graphic = $('#graphic');\n            this.$status = $('#status');\n\n            if (!this.settings.error) {\n                setTimeout(() => {\n                    this.postActionRequest();\n                }, 500);\n            } else {\n                var errorMsg = this.settings.message ? this.settings.message : this.settings.error;\n                this.$status.html(errorMsg);\n\n                setTimeout(() => {\n                    window.location = this.settings.redirectUrl;\n                }, 1000)\n            }\n        },\n\n        postActionRequest: function() {\n            var fragmentString = window.location.hash.substr(1);\n            var fragments = $.parseFragmentString(fragmentString);\n\n            Craft.postActionRequest('plugin-store/save-token', fragments, (response, textStatus, jqXHR) => {\n                if (textStatus == 'success') {\n                    if (response.error) {\n                        this.showError(response.error);\n                    } else {\n                        this.updateStatus('<p>' + Craft.t('app', 'Connected!') + '</p>');\n                        this.$graphic.addClass('success');\n\n                        // Redirect to the Dashboard in half a second\n                        setTimeout(() => {\n                            if (typeof (this.settings.redirectUrl) != 'undefined') {\n                                window.location = this.settings.redirectUrl;\n                            } else {\n                                window.location = Craft.getCpUrl('plugin-store');\n                            }\n                        }, 500);\n                    }\n                } else {\n                    this.showFatalError(jqXHR);\n                }\n            });\n        },\n\n        showFatalError: function(jqXHR) {\n            this.$graphic.addClass('error');\n            var statusHtml =\n                '<p>' + Craft.t('app', 'A fatal error has occurred:') + '</p>' +\n                '<div id=\"error\" class=\"code\">' +\n                '<p><strong class=\"code\">' + Craft.t('app', 'Status:') + '</strong> ' + Craft.escapeHtml(jqXHR.statusText) + '</p>' +\n                '<p><strong class=\"code\">' + Craft.t('app', 'Response:') + '</strong> ' + Craft.escapeHtml(jqXHR.responseText) + '</p>' +\n                '</div>' +\n                '<a class=\"btn submit big\" href=\"mailto:support@craftcms.com' +\n                '?subject=' + encodeURIComponent('Craft update failure') +\n                '&body=' + encodeURIComponent(\n                'Describe what happened here.\\n\\n' +\n                '-----------------------------------------------------------\\n\\n' +\n                'Status: ' + jqXHR.statusText + '\\n\\n' +\n                'Response: ' + jqXHR.responseText\n                ) +\n                '\">' +\n                Craft.t('app', 'Send for help') +\n                '</a>';\n\n            this.updateStatus(statusHtml);\n        },\n\n        updateStatus: function(html) {\n            this.$status.html(html);\n        },\n\n        showError: function(msg) {\n            this.$graphic.addClass('error');\n            this.updateStatus('<p>' + msg + '</p>');\n\n            var $buttonContainer = $('<div id=\"junction-buttons\"/>').appendTo(this.$status);\n\n            $cancelBtn = $('<a/>', {\n                'class': 'btn big',\n                'href': Craft.getCpUrl('plugin-store'),\n                text: \"Cancel\",\n            }).appendTo($buttonContainer);\n\n            $retryBtn = $('<a/>', {\n                'class': 'btn big',\n                'href': Craft.getActionUrl('plugin-store/connect'),\n                text: \"Try again\",\n            }).appendTo($buttonContainer);\n        }\n    });\n})(jQuery);\n"]}