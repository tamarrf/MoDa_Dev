{"version":3,"sources":["tablesettings/src/TableFieldSettings.js"],"names":["$","Craft","TableFieldSettings","Garnish","Base","extend","columnsTableName","defaultsTableName","columnsData","columnsTableId","defaultsTableId","columnsTableInputPath","defaults","columnSettings","dropdownSettingsCols","columnsTable","defaultsTable","init","dropdownSettingsHtml","formatInputId","this","split","initColumnsTable","filterArray","rowIdPrefix","defaultValues","onAddRow","initDefaultsTable","ColumnTable","type","onAddColumn","bind","reconstructDefaultsTable","$container","addListener","EditableTable","$tr","initColumnSettingInputs","$textareas","find","colId","options","getPostData","$tbody","i","key","expandPostArray","defaultsTableInputPath","length","hasOwnProperty","rowObj","data","append","theadHtml","rowId","createRow","appendTo","$table","id","fieldSettings","replaceWith","destroy","$typeSelect","$settingsBtn","settingsModal","baseName","columns","settings","optionsTable","base","table","initialize","$typeSelectContainer","$typeCell","createRowObj","role","Row","tr","handleTypeChange","removeClass","Math","class","$modal","html","handleOptionsRowChange","row","val","addClass","$closeButton","text","ev","$body","show","floor","random","handleSettingsModalHide","$bod","hide","replace","onDeleteRow","addRow","label","updateSizeAndPosition","value","prop","default","$rows","eq","$row","t","Modal","onHide","currentTarget","first","trigger","push","handleFormSubmit","name","JSON","stringify","jQuery"],"mappings":"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","file":"TableFieldSettings.min.js","sourcesContent":["(function($) {\n    /** global: Craft */\n    /** global: Garnish */\n    Craft.TableFieldSettings = Garnish.Base.extend({\n        columnsTableName: null,\n        defaultsTableName: null,\n        columnsData: null,\n        columnsTableId: null,\n        defaultsTableId: null,\n        columnsTableInputPath: null,\n        defaultsTableInputPath: null,\n\n        defaults: null,\n        columnSettings: null,\n\n        dropdownSettingsHtml: null,\n        dropdownSettingsCols: null,\n\n        columnsTable: null,\n        defaultsTable: null,\n\n        init: function(columnsTableName, defaultsTableName, columnsData, defaults, columnSettings, dropdownSettingsHtml, dropdownSettingsCols) {\n            this.columnsTableName = columnsTableName;\n            this.defaultsTableName = defaultsTableName;\n            this.columnsData = columnsData;\n\n            this.columnsTableId = Craft.formatInputId(this.columnsTableName);\n            this.defaultsTableId = Craft.formatInputId(this.defaultsTableName);\n\n            this.columnsTableInputPath = Craft.filterArray(this.columnsTableName.split(/[\\[\\]]+/));\n            this.defaultsTableInputPath = Craft.filterArray(this.defaultsTableName.split(/[\\[\\]]+/));\n\n            this.defaults = defaults;\n            this.columnSettings = columnSettings;\n\n            this.dropdownSettingsHtml = dropdownSettingsHtml;\n            this.dropdownSettingsCols = dropdownSettingsCols;\n\n            this.initColumnsTable();\n            this.initDefaultsTable();\n        },\n\n        initColumnsTable: function() {\n            this.columnsTable = new ColumnTable(this, this.columnsTableId, this.columnsTableName, this.columnSettings, {\n                rowIdPrefix: 'col',\n                defaultValues: {\n                    type: 'singleline'\n                },\n                onAddRow: this.onAddColumn.bind(this),\n                onDeleteRow: this.reconstructDefaultsTable.bind(this)\n            });\n        },\n\n        initDefaultsTable: function() {\n            this.defaultsTable = new Craft.EditableTable(this.defaultsTableId, this.defaultsTableName, this.columnsData, {\n                rowIdPrefix: 'row'\n            });\n        },\n\n        onAddColumn: function($tr) {\n            this.reconstructDefaultsTable();\n            this.initColumnSettingInputs($tr);\n        },\n\n        initColumnSettingInputs: function($container) {\n            var $textareas = $container.find('td:first-child textarea, td:nth-child(3) textarea');\n            this.addListener($textareas, 'input', 'reconstructDefaultsTable');\n        },\n\n        reconstructDefaultsTable: function() {\n            this.columnsData = Craft.expandPostArray(Garnish.getPostData(this.columnsTable.$tbody));\n            var defaults = Craft.expandPostArray(Garnish.getPostData(this.defaultsTable.$tbody));\n\n            var i, key;\n\n            for (i = 0; i < this.columnsTableInputPath.length; i++) {\n                key = this.columnsTableInputPath[i];\n                this.columnsData = this.columnsData[key];\n            }\n\n            // Add in the dropdown options\n            for (let colId in this.columnsData) {\n                if (this.columnsData.hasOwnProperty(colId) && this.columnsData[colId].type === 'select') {\n                    var rowObj = this.columnsTable.$tbody.find('tr[data-id=\"' + colId + '\"]').data('editable-table-row');\n                    this.columnsData[colId].options = rowObj.options || [];\n                }\n            }\n\n            for (i = 0; i < this.defaultsTableInputPath.length; i++) {\n                key = this.defaultsTableInputPath[i];\n\n                if (typeof defaults[key] === 'undefined') {\n                    defaults = {};\n                    break;\n                } else {\n                    defaults = defaults[key];\n                }\n            }\n\n            var theadHtml = '<thead>' +\n                '<tr>';\n\n            for (let colId in this.columnsData) {\n                if (!this.columnsData.hasOwnProperty(colId)) {\n                    continue;\n                }\n\n                theadHtml += '<th scope=\"col\">' + (this.columnsData[colId].heading ? this.columnsData[colId].heading : '&nbsp;') + '</th>';\n            }\n\n            theadHtml += '<th colspan=\"2\"></th>' +\n                '</tr>' +\n                '</thead>';\n\n            var $table = $('<table/>', {\n                id: this.defaultsTableId,\n                'class': 'editable fullwidth'\n            }).append(theadHtml);\n\n            var $tbody = $('<tbody/>').appendTo($table);\n\n            for (var rowId in defaults) {\n                if (!defaults.hasOwnProperty(rowId)) {\n                    continue;\n                }\n\n                Craft.EditableTable.createRow(rowId, this.columnsData, this.defaultsTableName, defaults[rowId]).appendTo($tbody);\n            }\n\n            this.defaultsTable.$table.replaceWith($table);\n            this.defaultsTable.destroy();\n            delete this.defaultsTable;\n            this.initDefaultsTable();\n        }\n    });\n\n    var ColumnTable = Craft.EditableTable.extend({\n        fieldSettings: null,\n\n        init: function(fieldSettings, id, baseName, columns, settings) {\n            this.fieldSettings = fieldSettings;\n            this.base(id, baseName, columns, settings);\n        },\n\n        initialize: function() {\n            if (!this.base()) {\n                return false;\n            }\n\n            this.fieldSettings.initColumnSettingInputs(this.$tbody);\n            this.sorter.settings.onSortChange = this.fieldSettings.reconstructDefaultsTable.bind(this.fieldSettings);\n            return true;\n        },\n\n        createRowObj: function($tr) {\n            return new ColumnTable.Row(this, $tr);\n        }\n    });\n\n    ColumnTable.Row = Craft.EditableTable.Row.extend({\n        $typeSelect: null,\n        $settingsBtn: null,\n\n        options: null,\n        settingsModal: null,\n        optionsTable: null,\n\n        init: function(table, tr) {\n            this.base(table, tr);\n\n            if (this.table.fieldSettings.columnsData[this.id]) {\n                this.options = this.table.fieldSettings.columnsData[this.id].options || null;\n            }\n\n            var $typeCell = this.$tr.find('td:nth-child(4)');\n            var $typeSelectContainer = $typeCell.find('.select');\n            this.$settingsBtn = $typeCell.find('.settings');\n\n            if (!this.$settingsBtn.length) {\n                this.$settingsBtn = $('<a/>', {\n                    'class': 'settings light invisible',\n                    role: 'button',\n                    'data-icon': 'settings'\n                });\n                $('<div/>', {'class': 'flex flex-nowrap'})\n                    .appendTo($typeCell)\n                    .append($typeSelectContainer)\n                    .append(this.$settingsBtn);\n            }\n\n            this.$typeSelect = $typeSelectContainer.find('select');\n            this.addListener(this.$typeSelect, 'change', 'handleTypeChange');\n            this.addListener(this.$settingsBtn, 'click', 'showSettingsModal');\n\n            this.addListener(this.$tr.closest('form'), 'submit', 'handleFormSubmit');\n        },\n\n        handleTypeChange: function() {\n            if (this.$typeSelect.val() === 'select') {\n                this.$settingsBtn.removeClass('invisible');\n            } else {\n                this.$settingsBtn.addClass('invisible');\n            }\n\n            this.table.fieldSettings.reconstructDefaultsTable();\n        },\n\n        showSettingsModal: function(ev) {\n            if (!this.settingsModal) {\n                var id = 'dropdownsettingsmodal' + Math.floor(Math.random() * 1000000);\n                var $modal = $('<div/>', {'class': 'modal dropdownsettingsmodal'}).appendTo(Garnish.$bod);\n                var $body = $('<div/>', {'class': 'body'})\n                    .appendTo($modal)\n                    .html(this.table.fieldSettings.dropdownSettingsHtml.replace(/__ID__/g, id));\n\n                this.optionsTable = new Craft.EditableTable(id, '__NAME__', this.table.fieldSettings.dropdownSettingsCols, {\n                    onAddRow: this.handleOptionsRowChange.bind(this),\n                    onDeleteRow: this.handleOptionsRowChange.bind(this)\n                });\n\n                if (this.options && this.options.length) {\n                    var row;\n                    for (var i = 0; i < this.options.length; i++) {\n                        row = this.optionsTable.addRow(false);\n                        row.$tr.find('.option-label textarea').val(this.options[i].label);\n                        row.$tr.find('.option-value textarea').val(this.options[i].value);\n                        row.$tr.find('.option-default input[type=\"checkbox\"]').prop('checked', !!this.options[i].default);\n                    }\n                } else {\n                    this.optionsTable.addRow(false);\n                }\n\n                var $closeButton = $('<button/>', {\n                    type: 'button',\n                    class: 'btn submit',\n                    text: Craft.t('app', 'Done')\n                }).appendTo($body);\n\n                this.settingsModal = new Garnish.Modal($modal, {\n                    onHide: this.handleSettingsModalHide.bind(this)\n                });\n\n                this.addListener($closeButton, 'click', function() {\n                    this.settingsModal.hide();\n                });\n            } else {\n                this.settingsModal.show();\n            }\n\n            setTimeout(() => {\n                this.optionsTable.$tbody.find('textarea').first().trigger('focus')\n            }, 100);\n        },\n\n        handleOptionsRowChange: function() {\n            if (this.settingsModal) {\n                this.settingsModal.updateSizeAndPosition();\n            }\n        },\n\n        handleSettingsModalHide: function() {\n            this.options = [];\n            var $rows = this.optionsTable.$table.find('tbody tr');\n            for (var i = 0; i < $rows.length; i++) {\n                let $row = $rows.eq(i);\n                this.options.push({\n                    label: $row.find('.option-label textarea').val(),\n                    value: $row.find('.option-value textarea').val(),\n                    default: $row.find('.option-default input[type=checkbox]').prop('checked')\n                })\n            }\n\n            this.table.fieldSettings.reconstructDefaultsTable();\n        },\n\n        handleFormSubmit: function(ev) {\n            if (this.$typeSelect.val() === 'select') {\n                $('<input/>', {\n                    type: 'hidden',\n                    name: this.table.fieldSettings.columnsTableName + '[' + this.id + '][options]',\n                    value: JSON.stringify(this.options)\n                }).appendTo(ev.currentTarget);\n            }\n        }\n    });\n})(jQuery);\n"]}